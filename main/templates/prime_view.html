<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Contractors</title>
</head>
<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
{%load static%}

<style>
    .parent{
        display: flex;
        min-height: 100dvh;
    }
    body{
        margin: 0;
        font-family: 'Inter';
    }
    .side_bar{
        padding: 0px 20px 0px 20px;
        display: flex;
        flex-direction: column;
        background-color: blue;
        color: white;
    }
    .side_bar ul{
        display: flex;
        flex-direction:column;
        padding:0;
        gap: 25px;
        height: 100dvh;
        margin: 0;
    }
    .side_bar ul li{
        list-style: none;
        cursor: pointer;
        margin-left: 10px;
    }
    .side_bar ul li i{
        margin-right: 5px;
    }
    .side_bar img{
        width: 160px;
        margin-top: 20px;
        margin-bottom: 35px;
    }
    .info{
        display:flex;
        flex:1;
        flex-direction: column;
        background-color: whitesmoke;
        padding: 0px 20px;
        height: 100dvh;
        overflow-y: scroll;
    }
    .header{
        padding: 21px 0px;
        display:flex;
        align-items: center;
        border-style: solid;
        border-width: 0px 0px 1px 0px;
    }
    .header label:first-of-type{
        font-size: 20px;
        color: darkblue;
        font-weight: bold;
    }
    .header div label:first-of-type{
        font-size: 16px;
    }
    .header div label:nth-of-type(2){
        font-size: 14px;
    }
    #Contractor_Registration_label
    {
        font-size: 18px;
        color:darkblue;
        font-weight: bold;
    }
    .form{
        background-color: white;
        display: flex;
        flex-direction: column;
    }
    .info_labels{
        padding: 10px;
        background:linear-gradient(to right,blue,darkblue);
        font-size: 18px;
        color: white;
        border-radius: 5px;
    }
    
    
    select,button{
        cursor: pointer;
    }
    
    
    .second_bar{
        display: flex;
        margin-top: 10px;
    }
    .second_bar select:first-of-type,.second_bar button:nth-of-type(1)
    {
        border-radius: 10px;
        border: 1px darkblue solid;
        color: darkblue;
        font-weight: bold;
        padding: 10px 30px;
    }
    .second_bar button,.second_bar select{
        display: flex;
        gap: 15px;
        align-items: center;
    }
    .second_bar button:last-of-type{
        background: linear-gradient(to right,blue,darkblue);
        color: white;
        border-radius: 10px;
        font-weight: bold;
        padding: 10px 30px;
        border: none;
    }
    .form div{
        display: flex;
        flex-direction: row;
        align-items: center;
        border-width: 0px 0px 1px 0px;
        border-style: solid;
        padding: 10px 0px;
    }
    .form div label{
        flex: 1;
    }
    .form div input{
        flex: .2;
        margin-left: 20px;
    }
    .form div label:first-of-type{
        flex: 1.3;
    }
    .form div label:last-of-type{
        margin-right: 20px;
    }
    .loader{
        display: flex;
        height: 100dvh;
        justify-content: center;
        align-items: center;
    }
    .loading_circle{
        border: 5px solid whitesmoke;
        border-radius: 50%;
        border-top: 5px solid blue;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    @keyframes spin{
        to{transform: rotate(360deg);}
    }
</style>
<body>
    <dialog id="dialog" style="border: none;background-color: white;border-radius: 30px;"></dialog>
    <div class="loader">
        <div class="loading_circle"></div>
    </div>
    <div class='parent'>
        <div class="side_bar">
            <ul>
                <img src="{% static 'prime.png' %}">
                <li><i class="fa-solid fa-gauge"></i> Dashboard</li>
                <li style='font-weight:bold'><i class="fa-solid fa-robot"></i> AI Assistant</li>
                <li><i class="fa-solid fa-users"></i> Customers</li>
                <li><i class="fa-solid fa-user-gear"></i> Subcontractors</li>
                <li><i class="fa-solid fa-cart-shopping"></i> Orders</li>
                <li><i class="fa-solid fa-briefcase"></i> Jobs</li>
                <li><i class="fa-solid fa-gear"></i> Settings</li>
                <li style="margin-top:auto;margin-bottom:25px"><i class="fa-solid fa-right-from-bracket"></i> Logout</li>
            </ul>
        </div>
        <div class="info">
            <div class="header">
                <label>Contractor</label>
                <img style="margin-left: auto;margin-right: 5px;" src="{% static 'Ellipse 8.png' %}">
                <div style="display: flex;flex-direction: column;">
                    <label style="font-weight: bold;color: darkblue;">Umer Aftab</label>
                    <label style="color:black">umeraftab763@gmail.com</label>

                </div>
            </div>
            <div class="second_bar" >
                <label ><i style="margin-right: 5px;" class="fas fa-solid fa-arrow-left"></i>Back</label>
                <select id="filter" style="margin-left: auto;margin-right: 10px;">
                    <option value="filter"> Filter By </option>
                    <option value="name"> Name </option>
                    <option value="date"> Date </option>
                    <option value="status"> Status </option>

                </select>
                <button style="margin-right: 10px;"><label id="date"></label>  <i class="fa-solid fa-calendar"></i></button>
                <button onclick="window.location.href='/prime_add'">Register Contractor <i class="fa-solid fa-user-plus"></i></button>
            </div>
            <label id="Contractor_Registration_label">Contractor List</label>
            <label style="margin-top: 5px;margin-bottom: 10px;">All Contractor</label>
            <div class="form">
                <div class="icons" style="font-weight: bold;">
                    <input type="checkbox">
                    <label>Name</label>
                    <label>Business Name</label>
                    <label>Services Offered</label>
                    <label>Status</label>
                    <label>Jobs Completed</label>
                    <label>Registered Date</label>
                    <label>Actions</label>




                </div>
                
            </div>
        </div>
    </div>
    <script>
        let dialog=document.getElementById('dialog')
        document.getElementById('date').innerHTML = new Date().toLocaleDateString()
        document.getElementsByClassName('parent')[0].style.display='none'
        document.getElementsByClassName('loader')[0].style.display='flex'

        fetch('/prime_view/all_contractors')
        .then(responce=>responce.json())
        .then(data=>
            {
                console.log(data.user_data)
                let filter=document.getElementById('filter')
                filter.addEventListener('change',()=>{
                    if(filter.value==='name')
                    {
                        let users=document.getElementsByClassName('form')[0]
                        users=Array.from(users.children)
                        users.splice(0,1)
                        users.sort((a,b)=>a.children[1].textContent.localeCompare(b.children[1].textContent))
                        data.user_data.sort((a,b)=>a.fullname.localeCompare(b.fullname))
                        console.log(users)
                        document.getElementsByClassName('form')[0].appendChild(document.getElementsByClassName('icons')[0])
                        for(let i=0;i<users.length;i++)
                        {
                            document.getElementsByClassName('form')[0].appendChild(users[i])
                        }
                    }
                    else if(filter.value==='date')
                    {
                        console.log((data.user_data))

                        let users=document.getElementsByClassName('form')[0]
                        users=Array.from(users.children)
                        users.splice(0,1)
                        for(let i=0;i<users.length-1;i++)
                        {
                            for(let j=0;j<users.length-1;j++)
                            {
                                if(new Date (data.user_data[j+1].date)>new Date(data.user_data[j].date))
                                {
                                    console.log(new Date (data.user_data[j+1].date),new Date(data.user_data[j].date))
                                    let temp=users[j]
                                    users[j]=users[j+1]
                                    users[j+1]=temp
                                    let temp1=data.user_data[j]
                                    data.user_data[j]= data.user_data[j+1]
                                    data.user_data[j+1]=temp
                                }
                            }
                        }
                        document.getElementsByClassName('form')[0].appendChild(document.getElementsByClassName('icons')[0])
                        for(let i=0;i<users.length;i++)
                        {
                            document.getElementsByClassName('form')[0].appendChild(users[i])
                        }
                    }
                    else if(filter.value==='status'){
                        let users=document.getElementsByClassName('form')[0]
                        users=Array.from(users.children)
                        users.splice(0,1)
                        users.sort((a,b)=>a.children[4].textContent.localeCompare(b.children[4].textContent))
                        data.user_data.sort((a,b)=>a.status.localeCompare(b.status))
                        console.log(users)
                        document.getElementsByClassName('form')[0].appendChild(document.getElementsByClassName('icons')[0])
                        for(let i=0;i<users.length;i++)
                        {
                            document.getElementsByClassName('form')[0].appendChild(users[i])
                        }
                    }
                })
                let user_data=data.user_data
                for(let i=0;i<user_data.length;i++)
                {
                    let div=document.createElement('div')
                    let input=document.createElement('input')
                    input.type='checkbox'
                    let name=document.createElement('label')
                    name.style.fontWeight='bold'
                    name.innerHTML=`
                    <span style="display:flex;align-items:center">
                        <img src=${user_data[i].img_workman} style="width:36px;height:36px;border-radius:50%;margin-right:10px">
                        <span style="display:flex;flex-direction:column">
                            <span>${user_data[i].fullname}</span>
                            <span>${user_data[i].email}</span>

                        </span>
                    </span>` 
                    let businessname=document.createElement('label')
                    businessname.innerHTML=user_data[i].businessname
                    let services=document.createElement('label')
                    services.innerHTML=user_data[i].services
                    let status=document.createElement('label')
                    status.innerHTML=user_data[i].status
                    status.style.fontWeight='bold'
                    status.style.color=user_data[i].status==='Verified'?'darkgreen':user_data[i].status==='Suspended'?'red':'orange'
                    let jobs=document.createElement('label')
                    jobs.innerHTML='20'
                    let date=document.createElement('label')
                    date.innerHTML=new Date(user_data[i].date).toLocaleDateString()
                    let actions=document.createElement('label')
                    actions.style.cursor='pointer'
                    let view = document.createElement('i');
                    view.classList.add('fa-solid', 'fa-eye', 'view-icon');
                    view.style.marginRight = '20px';
                    view.addEventListener('click',()=>
                    {
                        let person=i
                        dialog.showModal()
                        dialog.innerHTML=''
                        let div1=document.createElement('div')
                        div1.style.display='flex'
                        div1.style.flexDirection='column'
                        div1.style.backgroundColor='white'
                        let label1=document.createElement('label')
                        label1.innerHTML='Contractor Details'
                        label1.style.fontSize='20px'
                        label1.style.fontWeight='bold'
                        label1.style.marginBottom='10px'
                        label1.style.color='darkblue'
                        div1.appendChild(label1)
                        console.log(user_data[person])
                        let keys=['Email','Fullname','Phone','Business','Date Registered','Password','City','Area','Services','Preferences']
                        for(let i=0;i<10;i++)
                        {
                            let label=document.createElement('label')
                            if(i!==4){label.innerHTML=keys[i]+': '+Object.values(user_data[person])[i]}
                            else{label.innerHTML=keys[i]+': '+new Date( Object.values(user_data[person])[i]).toLocaleDateString()}
                            label.style.fontSize='16px'
                            label.style.marginBottom='10px'
                            label.style.color='black'
                            div1.appendChild(label)
                        }
                        dialog.append(div1)
                    })
                    let edit = document.createElement('i');
                    edit.classList.add('fa-solid', 'fa-pen-to-square', 'edit-icon');
                    edit.style.marginRight = '20px';
                    edit.addEventListener('click',()=>
                    {
                        window.location.href=`/prime_edit?${user_data[i].email}`
                    })
                    let del = document.createElement('i');
                    del.classList.add('fa-solid', 'fa-trash', 'delete-icon');
                    del.style.marginRight = '20px';
                    del.addEventListener('click',()=>
                    {
                        dialog.innerHTML=''
                        let div1=document.createElement('div')
                        div1.style.display='flex'
                        div1.style.flexDirection='column'
                        div1.style.backgroundColor='white'

                        let label1=document.createElement('label')
                        label1.innerHTML='Delete Contractor?'
                        label1.style.fontSize='20px'
                        label1.style.fontWeight='bold'
                        label1.style.marginBottom='10px'
                        label1.style.color='darkblue'
                        let label2=document.createElement('label')
                        label2.innerHTML='Are you sure you want to delete the contractor?'
                        label2.style.fontSize='16px'
                        label2.style.color='black'
                        label2.style.marginBottom='30px'
                        let div_again=document.createElement('div')
                        div_again.style.display='flex'
                        div_again.style.justifyContent='space-evenly'

                        let no=document.createElement('button')
                        no.innerHTML='No'
                        no.style.color='white'
                        no.style.fontWeight='bold'
                        no.style.fontSize='16px'
                        no.style.borderRadius='10px'
                        no.style.width='100px'
                        no.style.border='none'
                        no.style.backgroundColor='darkblue'
                        no.style.padding='10px 0px'

                        no.addEventListener('click',()=>
                        {
                            dialog.close()
                        })
                        let yes=document.createElement('button')
                        yes.innerHTML='Yes'
                        yes.style.color='white'
                        yes.style.fontWeight='bold'
                        yes.style.fontSize='16px'
                        yes.style.borderRadius='10px'
                        yes.style.width='100px'
                        yes.style.border='none'
                        yes.style.padding='10px 0px'
                        yes.style.background='linear-gradient(to right, blue, darkblue)'
                        yes.addEventListener('click',()=>
                        {
                            fetch('/prime_view/delete_user',{
                                method:'POST',
                                headers:{
                                    'Content-type':'application/json'
                                },
                                body:JSON.stringify({email:user_data[i].email})
                            })
                            .then(responce=>responce.json())
                            .then(data=>
                            {
                                document.getElementsByClassName('form')[0].removeChild(div)
                                dialog.close()
                            })
                        })
                        div1.appendChild(label1)
                        div1.appendChild(label2)
                        div_again.appendChild(no)
                        div_again.appendChild(yes)
                        div1.appendChild(div_again)
                        dialog.append(div1)
                        dialog.showModal()
                    })
                    actions.append(view)
                    actions.append(edit)
                    actions.append(del)
                    div.appendChild(input)
                    div.appendChild(name)
                    div.appendChild(businessname)
                    div.appendChild(services)
                    div.appendChild(status)
                    div.appendChild(jobs)
                    div.appendChild(date)
                    div.appendChild(actions)
                    document.getElementsByClassName('form')[0].appendChild(div)
                    console.log(getComputedStyle(services).width)
                    console.log(getComputedStyle(name).width)
                    

                }
                document.getElementsByClassName('parent')[0].style.display='flex'
                document.getElementsByClassName('loader')[0].style.display='none'
            }
        )
    </script>
</body>
</html>